<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ustudy.exam.dao.ExamDao">

	<resultMap type="com.ustudy.exam.model.Exam" id="ExamResult">
        <id property="id" column="id"/>
        <result property="examName" column="exam_name"/>
        <result property="examDate" column="exam_date"/>
        <result property="type" column="type"/>
        <result property="status" column="status"/>
    </resultMap>

	<!-- 查询得到全部Exam对象 -->
	<select id="getAllExams" parameterType="string" resultMap="ExamResult">
		SELECT * FROM exam
	</select>
	
	<select id="getExams" parameterType="java.util.Map" resultMap="ExamResult">
		SELECT * FROM exam where 1=1
		<if test="finished == false">
		 AND status &lt;&gt; 2
		</if>
		<if test="finished == true">
		 AND status = 2
		</if>
		<if test="gradeId > 0">
		 AND id IN (SELECT DISTINCT examid from examgradesub where grade_id=#{gradeId})
		</if>
		<if test="subjectId > 0">
		 AND id IN (SELECT DISTINCT examid from examgradesub where sub_id=#{subjectId})
		</if>
		<if test="starDate != ''">
		 AND exam_date &gt;= #{starDate,jdbcType=VARCHAR}
		</if>
		<if test="endDate != ''">
		AND exam_date &lt;= #{endDate,jdbcType=VARCHAR}
		</if>
		<if test="name != ''">
		AND exam_name LIKE concat('%',#{name,jdbcType=VARCHAR},'%')
		</if>
	</select>
	
	<select id="getExamGrades" parameterType="Long" resultType="java.util.Map">
		SELECT id,grade_name from grade where id IN (SELECT DISTINCT grade_id from examgradesub where examid=#{examid}) ORDER BY id
	</select>
	
	<select id="getExamSubjects" parameterType="Long" resultType="java.util.Map">
		SELECT id,name from subject where id IN (SELECT DISTINCT sub_id from examgradesub where examid=#{examid}) ORDER BY id
	</select>

	<!-- 根据类型查询得到Exam对象 -->
	<select id="getExamsByStatus" parameterType="string" resultMap="ExamResult">
		SELECT * FROM exam where status=#{status}
	</select>

	<!-- 根据ID查询得到一个Exam对象-->
	<select id="getExamsById" parameterType="Long" resultMap="ExamResult">
		SELECT * FROM exam where id=#{id}
	</select>

	<select id="getGrades" resultType="java.util.Map">
		select * from grade
	</select>

	<select id="getSubjects" resultType="java.util.Map">
		select * from subject
	</select>
	
	<select id="getLastExam" resultMap="ExamResult">
		SELECT e.* from examgradesub egs LEFT JOIN exam e on egs.examid=e.id ORDER BY e.exam_date DESC LIMIT 1 
	</select>
</mapper>